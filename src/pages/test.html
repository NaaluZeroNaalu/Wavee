<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Particle Circle with Transcript</title>
  <style>
    body {
      margin: 0;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
    }
    .controls {
      position: absolute;
      bottom: 30px;
      display: flex;
      gap: 12px;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      background: #007bff;
      color: white;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .transcript {
      position: absolute;
      top: 30px;
      width: 80%;
      max-width: 700px;
      background: rgba(0, 0, 0, 0.05);
      padding: 15px;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
      min-height: 40px;
    }

     .top-menu {
    position: absolute;
    top: 20px;
    right: 20px;
  }

  .menu-btn {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  .menu-panel {
    position: absolute;
    top: 80px;
    right: 20px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    display: none; /* hidden by default */
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  .menu-panel input[type="file"] {
    border: 1px solid #ccc;
    padding: 6px;
    border-radius: 6px;
  }

  .menu-panel button {
    background: #28a745;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="transcript" id="transcript">Transcript will appear here...</div>

  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

  <!-- Top Right Menu -->
  <div class="top-menu">
    <button class="menu-btn" id="menuToggle">â˜°</button>
    <div class="menu-panel" id="menuPanel">
      <input type="file" id="prescriptionUpload" accept=".jpg,.png,.pdf,.doc,.docx" />
      <button id="finalizeBtn">Finalize</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("particleCanvas");
    const ctx = canvas.getContext("2d");
    const transcriptBox = document.getElementById("transcript");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    const numParticles = 500;
    const baseRadius = 150;
    const particles = [];

    for (let i = 0; i < numParticles; i++) {
      let angle = (i / numParticles) * Math.PI * 2;
      let offset = Math.random() * 20 - 10;
      particles.push({
        angle: angle,
        radius: baseRadius + offset,
        size: Math.random() * 6 + 2,
        speed: Math.random() * 0.002 + 0.001,
      });
    }

    // mic + audio setup
    let audioCtx, analyser, micStream;
    let audioData = new Uint8Array(128);
    let audioLevel = 0;

    async function initMic() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);
    }

    function getAudioLevel() {
      if (analyser) {
        analyser.getByteFrequencyData(audioData);
        let sum = 0;
        for (let i = 0; i < audioData.length; i++) {
          sum += audioData[i];
        }
        audioLevel = sum / audioData.length;
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const cx = canvas.width / 2;
      const cy = canvas.height / 2;

      getAudioLevel();

      particles.forEach((p) => {
        p.angle += p.speed * (Math.random() > 0.5 ? 1 : -1);

        let dynamicRadius = p.radius + audioLevel * 0.5;

        let x = cx + dynamicRadius * Math.cos(p.angle);
        let y = cy + dynamicRadius * Math.sin(p.angle);

        ctx.beginPath();
        ctx.arc(x, y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(0, 120, 255, 0.35)";
        ctx.shadowColor = "rgba(0, 120, 255, 1)";
        ctx.shadowBlur = 20;
        ctx.fill();
      });

      requestAnimationFrame(animate);
    }
    animate();

    
     // ----------- Speech Recognition -----------
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  let fullTranscript = ""; // store all spoken text

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onresult = (event) => {
      let interimTranscript = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          fullTranscript += transcript + " "; // append final text
        } else {
          interimTranscript += transcript; // still speaking
        }
      }
      transcriptBox.textContent = fullTranscript + interimTranscript;
    };

    recognition.onerror = (event) => {
      transcriptBox.textContent = "Error: " + event.error;
    };
  } else {
    transcriptBox.textContent = "SpeechRecognition not supported in this browser.";
    startBtn.disabled = true;
  }

  // ----------- Button actions -----------
  startBtn.onclick = async () => {
    await initMic();
    fullTranscript = ""; // reset on new start
    recognition.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  stopBtn.onclick = () => {
    recognition.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };

  resetBtn.onclick = () => {
    fullTranscript = "";
    transcriptBox.textContent = "Transcript will appear here...";
  };


  // ----------- Top Right Menu -----------
  const menuToggle = document.getElementById("menuToggle");
    const menuPanel = document.getElementById("menuPanel");
    const finalizeBtn = document.getElementById("finalizeBtn");
    const prescriptionUpload = document.getElementById("prescriptionUpload");

    // Toggle menu visibility
    menuToggle.onclick = () => {
      menuPanel.style.display =
        menuPanel.style.display === "flex" ? "none" : "flex";
    };

    // Handle finalize
    finalizeBtn.onclick = () => {
      if (prescriptionUpload.files.length > 0) {
        alert("Prescription uploaded: " + prescriptionUpload.files[0].name + "\nFinalized!");
      } else {
        alert("Please upload a prescription before finalizing.");
      }
    };
  </script>
</body>
</html>
